jQuery(document).ready(function(h){$tipsDelay=4000;_min=1;_max=9;h("body").delegate(".wish","mouseover",function(z){h(this).addClass("wishhover")});h("body").delegate(".wish","mouseleave",function(z){h(this).removeClass("wishhover")});h("body").delegate(".delete,.giftdelete","mouseover",function(z){h(this).addClass("deletecur")});h("body").delegate(".delete,.giftdelete","mouseleave",function(z){h(this).removeClass("deletecur")});h("body").delegate("select","change",function(A){var B=h(this);var z={};z={pid:B.val(),rowid:B.closest("tr").find("input").data("rowid")};h.ajax({url:"/ajax/cart/change_promotion?"+Math.random(),type:"POST",dataType:"json",data:z,success:function(C){if(C.code===1){g()}}})});h("body").delegate(".wish","click",function(B){B.preventDefault();var A={};var C=h(this);if(!C.hasClass("wishcur")){var z='<span class="wishsuccess"></span>';A.comid=C.closest("tr").find("input").data("comid");h.ajax({url:"/ajax/wish/fancy/",type:"POST",dataType:"json",data:A,success:function(E){if(E.code===-1){v("/cart")}else{C.addClass("wishcur");C.append(z);var D=C.find(".wishsuccess");D.animate({opacity:1},200,function(){setTimeout(function(){D.animate({opacity:0},200,function(){D.remove()})},500)})}}})}});if(h("div").hasClass("cartlist")){h(".delete").confirm({msg:"确定要删除该商品么？",onOK:function(C){var B=h(C.target);var A=[];A[0]=B.closest("tr").find("input").data("rowid");var z={target:C,rowid:A};f(z)},onCancel:function(){}})}if(h("div").hasClass("cartlist")){h(".giftdelete").confirm({msg:"确定要删除该商品么？",onOK:function(F){var E=h(F.target);var C=E.closest("tr").find("input").data("rowid");var z=E.closest("tr").find("input").data("size");var B=E.closest("tr").find("input").data("pid");var D=E.closest("tr").find("input").data("comid");var A={target:F,rowid:C,pid:B,gift_comid:D,gift_size:z};j(A)},onCancel:function(){}})}h("body").delegate("#delall","click",function(z){l(z)});function l(C){if(h(".cartlistin .cur").length==0){alert("请选择要删除的商品")}else{var A=confirm("确定要删除所选商品么？");if(A===true){var D=h(C.target);var B=[];h(".cartlistin .cur").each(function(){B.push(h(this).closest("tr").find("input").data("rowid"))});var z={target:C,rowid:B};f(z)}}}h("body").delegate("#delnostock","click",function(z){x(z)});function x(C){var A=confirm("确定要删除所有售罄商品么？");if(A===true){var D=h(C.target);var B=[];h(".nostock").each(function(){B.push(h(this).closest("tr").find("input").data("rowid"))});var z={target:C,rowid:B};f(z)}}function f(z){h.ajax({url:"/ajax/cart/remove_items?"+Math.random(),type:"POST",dataType:"json",data:{rowid:z.rowid},success:function(A){if(A.code===1){g()}else{y(z.target,"err",A.msg)}}})}function j(z){h.ajax({url:"/ajax/cart/remove_gift?"+Math.random(),type:"POST",dataType:"json",data:{rowid:z.rowid,pid:z.pid,gift_comid:z.gift_comid,gift_size:z.gift_size},success:function(A){if(A.code===1){g()}else{y(z.target,"err",A.msg)}}})}h("body").delegate(".cartlist .add","click",function(D){D.preventDefault();var F=h(this);var B=F.closest("td").find("input");var A=parseInt(B.val());var z={maxnum:F.closest("td").find("input").data("max"),minnum:F.closest("td").find("input").data("min")};if(!F.hasClass("noadd")){if(A>=_max){y(D,"err","商品数量不能超过9个");return false}else{A++;var C=F.closest("td").find("input").data("rowid");var E={row_id:C,num:A};b(B,E,D,z)}}});h("body").delegate(".cartlist .zpadd","click",function(D){D.preventDefault();var F=h(this);var B=F.closest("td").find("input");var A=parseInt(B.val());var C=parseInt(F.closest("tr").find(".sizecur").data("stock"));if(F.closest("tr").find(".giftcheckbox").hasClass("cur")){F.closest("tr").find(".ordermsg").text("").hide();var E=parseInt(h("#gift .tit").data("remain"));var z=parseInt(h("#gift .tit").data("has"));if(A<C){if(w(D)===0){F.closest("tr").find(".ordermsg").text("超过数量").show();return false}else{A++;B.val(A);h("#gift .tit").data("has",z+1);h("#gift .tit").data("remain",E-1);h("#gift .tit").find("i").eq(1).text(z+1);F.closest("td").find(".zpreduce").removeClass("nozpreduce")}}else{F.closest("tr").find(".ordermsg").text("库存不足").show()}}else{if(!F.closest("tr").find("span").hasClass("sizecur")){F.closest("tr").find(".ordermsg").text("请选择赠品尺码").show();return false}}});h("body").delegate(".cartlist .zpreduce","click",function(B){B.preventDefault();var D=h(this);var A=D.closest("td").find("input").val();var C=parseInt(h("#gift .tit").data("remain"));var z=parseInt(h("#gift .tit").data("has"));if(!D.hasClass("nozpreduce")){A--;D.closest("td").find("input").val(A);h("#gift .tit").data("has",z-1);h("#gift .tit").data("remain",C+1);h("#gift .tit").find("i").eq(1).text(z-1);if(A==1){D.addClass("nozpreduce")}}});function w(A){var C=h(A.target);var B=parseInt(h("#gift .tit").data("remain"));var z=parseInt(C.closest("tr").find(".sizecur").data("stock"));return Math.min(B,z,9)}h("body").delegate("#gift .btn span","click",function(G){var E=h(this);if(E.closest("#gift").find(".giftcheckbox").hasClass("cur")){var F=h("#gift .cur");var B=0;var z=E.data("rowid");var D=E.data("pid");var H=[];var C=[];var I=[];for(B=0;B<F.size();B++){H[B]=F.eq(B).closest("tr").find("input").eq(0).data("comid");C[B]=F.eq(B).closest("tr").find(".sizecur").data("size");I[B]=F.eq(B).closest("tr").find("input").eq(1).val()}var A={};A={rowid:z,pid:D,gift_comid:H,gift_size:C,gift_quantity:I};h.ajax({url:"/ajax/cart/add_gift?"+Math.random(),type:"POST",dataType:"json",data:A,success:function(J){if(J.code===1){window.location.reload()}else{h(".giftsubmitmsg").text(J.msg)}}})}else{}});h("body").delegate(".cartlist .reduce","click",function(D){D.preventDefault();var F=h(this);var B=F.closest("td").find("input");var A=parseInt(B.val());var z={maxnum:F.closest("td").find("input").data("max"),minnum:F.closest("td").find("input").data("min")};A--;var C=F.closest("td").find("input").data("rowid");var E={row_id:C,num:A};if(!F.hasClass("noreduce")){b(B,E,D,z)}});h("body").delegate(".namesize p span","click",function(z){var B=h(this);var A=parseInt(h("#gift .tit").data("remain"));if(B.closest("p").find("span").hasClass("sizecur")){if(!B.hasClass("sizecur")){B.addClass("sizecur");B.siblings().removeClass("sizecur");if(!B.closest("tr").find(".giftcheckbox").hasClass("cur")){B.closest("tr").find(".giftcheckbox").trigger("click")}}}else{if(A>0){if(!B.hasClass("sizecur")){B.addClass("sizecur");B.siblings().removeClass("sizecur");if(!B.closest("tr").find(".giftcheckbox").hasClass("cur")){B.closest("tr").find(".giftcheckbox").trigger("click")}}}else{B.closest("tr").find(".giftcheckbox").trigger("click")}}});h("body").delegate("#gift .giftcheckbox","click",function(B){var D=h(this);var z=parseInt(D.closest("tr").find("input").eq(1).val());var C=parseInt(h("#gift .tit").data("remain"));var A=parseInt(h("#gift .tit").data("has"));if(C===0){if(D.hasClass("cur")){D.closest("tr").find(".ordermsg").text("").hide();if(D.closest("tr").find("span").hasClass("sizecur")){D.closest("tr").find(".ordermsg").text("").hide();if(!D.hasClass("cur")){if(z===C){D.addClass("cur");h("#gift .tit").data("remain",0);h("#gift .tit").data("has",A+z);h("#gift .tit").find("i").eq(1).text(A+z)}else{if(z<C){D.addClass("cur");h("#gift .tit").data("remain",C-z);h("#gift .tit").data("has",A+z);h("#gift .tit").find("i").eq(1).text(A+z)}}}else{D.removeClass("cur");h("#gift .tit").data("remain",C+z);h("#gift .tit").data("has",A-z);h("#gift .tit").find("i").eq(1).text(A-z)}}else{D.closest("tr").find(".ordermsg").text("请选择赠品尺码").show()}}else{D.closest("tr").find(".ordermsg").text("赠品已满").show()}}else{D.closest("tr").find(".ordermsg").text("").hide();if(D.closest("tr").find("span").hasClass("sizecur")){D.closest("tr").find(".ordermsg").text("").hide();if(!D.hasClass("cur")){if(z===C){D.addClass("cur");h("#gift .tit").data("remain",0);h("#gift .tit").data("has",A+z);h("#gift .tit").find("i").eq(1).text(A+z)}else{if(z<C){D.addClass("cur");h("#gift .tit").data("remain",C-z);h("#gift .tit").data("has",A+z);h("#gift .tit").find("i").eq(1).text(A+z)}}}else{D.removeClass("cur");h("#gift .tit").data("remain",C+z);h("#gift .tit").data("has",A-z);h("#gift .tit").find("i").eq(1).text(A-z)}}else{D.closest("tr").find(".ordermsg").text("请选择赠品尺码").show()}}});function b(C,A,B,z){h.ajax({url:"/ajax/cart/updateQty?"+Math.random(),type:"POST",dataType:"json",data:A,success:function(E){var D=C;if(E.code===1){C.val(A.num);y(B,"success","数量修改成功");if(D.data("ori")){D.data("ori",A.num)}g()}else{y(B,"err",E.msg);if(D.data("ori")){D.val(D.data("ori"))}}}})}function g(){h.ajax({url:"/ajax/cart/refresh?"+Math.random(),dataType:"json",success:function(z){if(z.code===1){if(z.data.html!=""){h(".cartcen").html(z.data.html);r()}else{window.location.reload()}if(z.data.checked_all){h(".checkboxall").addClass("allcur")}else{h(".checkboxall").removeClass("allcur")}h("#total_num").text(z.data.summary.total_num);h("#total_last_all").text(z.data.summary.total_last_all);h("#total_last_reduce").text(z.data.summary.total_last_reduce);h("#total_price").text(z.data.summary.total_price)}else{window.location.reload()}}})}function y(B,A,C){if(A=="err"){_class="checkTipsErr"}else{_class="checkTips"}h(".checkTipsErr").remove();h(".checkTips").remove();h("<p />").addClass(_class).css({opacity:0}).html(C).prependTo(h(B.target).closest("body")).append('<i class="arr" />');if(A=="err"){_this=h("body").find("p.checkTipsErr").eq(0)}else{_this=h("body").find("p.checkTips").eq(0)}_this.css({top:h(B.target).position().top,left:z(B)}).animate({opacity:1,top:"-=30"},100).delay($tipsDelay).animate({opacity:0},500,function(){h(this).remove()});function z(D){return h(D.target).position().left-(_this.width()-h(D.target).width())/2-7}}function e(A){var z="/ajax/cart/getTotal?"+Math.random();h.ajax({url:z,dataType:"json",type:"POST",async:false,success:function(B){if(B.code===1){h("#total_num").text(B.total_num);h("#total_last_all").text(B.total_last_all);h("#total_last_reduce").text(B.total_last_reduce);h("#total_price").text(B.total_price);return true}else{return false}}})}function s(z,D,B){var A="/ajax/cart/change_selected?"+Math.random();var E=h(D.target);var C={};C={is_selected:z,row_id:B};h.ajax({url:A,dataType:"json",data:C,type:"POST",async:false,success:function(F){if(F.code===1){g()}}})}h("body").delegate(".checkbox","click",function(B){var C=h(this);var z=true;var A=C.closest("tr").find("input").data("rowid");if(C.hasClass("cur")){z=false}else{z=true}s(z,B,A)});function q(){if(h(".cartlistin .checkbox").size()===h(".cartlistin .cur").size()){h(".checkboxall").addClass("allcur")}else{h(".checkboxall").removeClass("allcur")}}h("body").delegate(".checkboxall,.all","click",function(C){k();var z=true;_this=h(this);if(_this.closest("th").find(".checkboxall").hasClass("allcur")){z=false}else{z=true}var A="/ajax/cart/update_checked_all?"+Math.random();var B={};B={is_selected:z};h.ajax({url:A,dataType:"json",data:B,type:"POST",async:true,success:function(D){if(D.code===1){g()}else{r()}}})});h("body").delegate(".zpbtn","mouseover",function(z){h(this).addClass("zpbtnhover")});h("body").delegate(".zpbtn","mouseleave",function(z){h(this).removeClass("zpbtnhover")});h("body").delegate(".zpbtn","click",function(B){var E=h(this);var z=E.data("pid");var C=E.data("rowid");var D=E.data("comid");var A={};A={pid:z,rowid:C,comid:D};h.ajax({url:"/ajax/cart/get_gift?"+Math.random(),type:"POST",dataType:"json",data:A,success:function(F){if(F.code===1){h("#gift").html(F.data);h("#gift").show();h("#back").show()}else{y(sugs.target,"err",F.msg)}}});h(this).addClass("zpbtnclick")});h("body").delegate("#gift #close,#back","click",function(z){h(".zpbtn").removeClass("zpbtnclick");h("#gift").html("");h("#gift").hide();h("#back").hide()});h("#submit").mouseenter(function(z){h(this).css("background","#bd004d")}).mouseleave(function(z){h(this).css("background","#d70057")});h("body").delegate("#submit","click",function(z){var B=h(this);B.addClass("submitcur");var A;if(h(".cur").length>0){h.ajax({url:"ajax/cart/saveCartContents",type:"POST",dataType:"json",beforeSend:function(){B.html("结算中...")},success:function(C){switch(C.code){case"-13":h("#isCart").val("0");v("/cart");B.html("去结算");break;case 2:h("#isCart").val("0");v("/cart");B.html("去结算");break;case 0:d(z,C.msg);setTimeout(function(){window.location.reload()},$tipsDelay);break;case"-1":d(z,C.msg);setTimeout(function(){window.location.reload()},$tipsDelay);break;case"-10":d(z,C.msg);B.html("去结算");break;case 1:window.location.href="/checkout/form";break;case"-12":d(z,C.msg);setTimeout(function(){window.location.href="/member/realname_identify?cart"},3000);break;default:d(z,C.msg);B.html("去结算")}}})}else{A="请选择商品";d(z,A)}});function d(C,D){var F=h(C.target);var z='<span class="submsg">'+D+"</span>";F.removeClass("submitcur");h("body").append(z);var E=(h(".submsg").width()+20)/2;h(".submsg").css({"margin-left":520-E});if(F.closest(".cartsumout").css("position")=="static"){var B=h(".cartsumout").offset().top-30;h(".submsg").css({position:"absolute",top:B})}var A=h(".submsg");A.animate({opacity:1},200,function(){setTimeout(function(){A.animate({opacity:0},200,function(){A.remove()})},1000)})}p();var n=h(window).height();function p(){var z=h(".cartcen").height();if(z>n){h(".cartsumout").removeClass("cartsumoutbtm")}}h(window).scroll(function(A){if(h("div").hasClass("cartlist")){var B=h(window).scrollTop()+n;var z=h("#dialog").offset().top;if(B>=z){h(".cartsumout").addClass("cartsumoutbtm")}else{h(".cartsumout").removeClass("cartsumoutbtm")}}});h(".cartlogin a").click(function(z){z.preventDefault();h("#isCart").val("0");v("/cart")});function v(z){h.ajax({url:"/members/login/fast_login?jumpurl="+z,success:function(A){h("#dialog").html(A);h("#dialog").dialog({autoOpen:true,closeOnEscape:true,modal:true,width:320,position:"center"}).dialog("open")}})}function m(){h("#bfdlist").Slider({prevId:".related-leftbtn .leftOn",nextId:".related-rightbtn .rightOn",shownum:4,offbtnleft:"left",offbtnright:"right",offline:1});h(".related-leftbtn,.related-rightbtn").click(function(){h("#bfdlist img").each(function(){if(h(this).attr("original")&&this.src!=h(this).attr("original")){this.src=h(this).attr("original")}})})}function i(A){var z=document.cookie.match(new RegExp("(^| )"+A+"=([^;]*)(;|$)"));if(z!=null){return unescape(z[2])}return""}function a(D){var B="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var A="";var K,I,G="";var J,H,F,E="";var C=0;if(D.length%4!=0){return""}var z=/[^A-Za-z0-9\+\/\=]/g;if(z.exec(D)){return""}do{J=B.indexOf(D.charAt(C++));H=B.indexOf(D.charAt(C++));F=B.indexOf(D.charAt(C++));E=B.indexOf(D.charAt(C++));K=(J<<2)|(H>>4);I=((H&15)<<4)|(F>>2);G=((F&3)<<6)|E;A=A+String.fromCharCode(K);if(F!=64){A+=String.fromCharCode(I)}if(E!=64){A+=String.fromCharCode(G)}K=I=G="";J=H=F=E=""}while(C<D.length);return A}function u(){var A=0;var B=i("uidInfo");var C=a(B);var z=C.split("-");if(z.length>1){A=z[1]}return A}var c=u();var o=t();window._BFD=window._BFD||{};_BFD.BFD_INFO={cart_items:o,user_id:c,page_type:"shopcart",client_id:"Chaolemai"};_BFD.bfdShow1=function(z){showbind5(z);var C=0;var B="";if(z){B+="<ul>";for(var A in z){C++;B+="<li>";B+='<a href="'+z[A].url+'" target="_blank" title="'+z[A].subname+'">';B+='<img src="'+z[A].img+'" alt="'+z[A].subname+'" /></a>';B+='<a href="'+z[A].url+'" target="_blank" title="'+z[A].subname+'"><em>'+z[A].name+"</em></a>";B+="<p><span>&yen;"+z[A].prc+"</span></p>";B+="</li>";if(C>1&&C<24&&C%5===0){B+="</ul><ul>"}}B+="</ul>";h("#bfdlist").html(B);m()}};function t(){var F=[];var B=[];var H=[];h(".checkbox").each(function(){F.push(h(this).attr("sku"))});h(".checkbox").each(function(){B.push(h(this).closest("tr").find("pr").text())});h(".checkbox").each(function(){H.push(h(this).closest("tr").find("input").val())});var A=new Array();var z={};for(var E=0;E<F.length;E++){z[F[E]]=z[F[E]]||{};z[F[E]]["sku"]=F[E];z[F[E]]["price"]=B[E];var C=z[F[E]]["num"]||0;z[F[E]]["num"]=parseInt(C)+parseInt(H[E])}var A=h.makeArray(z);var G=new Array();for(var E in z){var D=new Array();D.push(z[E].sku);D.push(z[E].price);D.push(z[E].num);G.push(D)}return G}function k(){h("#back").show();h(".loading").show()}function r(){h("#back").hide();h(".loading").hide()}});